<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/utils/render-status.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/gw2-coin-output/gw2-coin-output.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-tickets">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        min-height: calc(100vh - 4rem);
      }

      .title {
        margin: 0;
        font-weight: 300;
        height: 1.75rem;
        display: flex;
        align-items: center;
      }

      .card {
        margin: var(--spacer-large);
        max-width: 30rem;
      }

      gw2-coin-output {
        display: block;
      }

      paper-spinner {
        display: none;
        margin-left: var(--spacer-medium);
      }

      paper-spinner[active] {
        display: inline-block;
      }
    </style>

    <p class="description">Ever wondered what it would cost to buy a Black Lion Claim Ticket with gold?<br> This tool does the math for you, so you don't have to.</p>

    <div class="card">
      <p class="title">Average Listing Price
          <paper-spinner active="[[averageSellLoading]]"></paper-spinner></p>
      <gw2-coin-output class="display-3" coin-string="[[averageSell]]"></gw2-coin-output>
    </div>
    <div class="card">
      <p class="title">Average Order Price
          <paper-spinner active="[[averageBuyLoading]]"></paper-spinner></p>
      <gw2-coin-output class="display-3" coin-string="[[averageBuy]]"></gw2-coin-output>
    </div>

    <paper-toast id="toast" duration="0" text="An error occured."></paper-toast>
  </template>

  <script>
    class MyTickets extends Polymer.Element {
      static get is() { return 'my-tickets'; }

      static get properties() {
        return {
          collectionData: {
            type: Array,
            observer: '_calculateAverage'
          },
          averageBuy: {
            type: Number
          },
          averageSell: {
            type: Number
          },
          averageBuyLoading: {
            type: Boolean,
            value: true
          },
          averageSellLoading: {
            type: Boolean,
            value: true
          }
        };
      }

      ready() {
        super.ready();

        Polymer.RenderStatus.afterNextRender(this, function() {
          this._loadCollectionData();
        });
      }

      _calculateAverage(collectionData) {
        let averageBuy = 0;
        collectionData.forEach(collection => averageBuy += this._calcTotalPrices(collection.items, "buys"));
        averageBuy = averageBuy / collectionData.length;
        this.set('averageBuy', averageBuy);
        this.set('averageBuyLoading', false);

        let averageSell = 0;
        collectionData.forEach(collection => averageSell += this._calcTotalPrices(collection.items, "sells"));
        averageSell = averageSell / collectionData.length;
        this.set('averageSell', averageSell);
        this.set('averageSellLoading', false);
      }

      _calcTotalPrices(items, buysOrSells) {
        let totalPrices = 0;
        let totalAverage = 0;

        switch (buysOrSells) {
          case 'sells':
            items.forEach((item) => { totalPrices += item.sells.unit_price });
            break;
          case 'buys':
          default:
            items.forEach((item) => { totalPrices += item.buys.unit_price });
            break;
        }

        totalAverage = totalPrices / items.length;
        return totalAverage;
      }

      async _loadCollectionData() {
        const collectionMeta = await fetch('./src/data/collections.json');

        if (collectionMeta.status !== 200) {
          console.log(collectionMeta.status, collectionMeta.statusText);
          this.$.toast.fitInto = this;
          this.$.toast.open();
        }

        const collectionJson = await collectionMeta.json();
        const collectionData = this._filterEntries(collectionJson, 'blacklion');
        const collectionDataWithPrices = await Promise.all(collectionData.map(async collection => {
          return Object.assign({}, collection, { items: await this._loadItemData(collection.ids) });
        }, this));

        this.set('collectionData', collectionDataWithPrices);
      }

      async _loadItemData(ids) {
        const itemsData = await fetch('https://api.guildwars2.com/v2/items?ids=' + ids);
        const pricesData = await fetch('https://api.guildwars2.com/v2/commerce/prices?ids=' + ids);
        const itemsJson = await itemsData.json();
        const pricesJson = await pricesData.json();

        return itemsJson.map(item => {
          return Object.assign({}, item, pricesJson.find(price => price.id === item.id));
        });
      }

      _filterEntries(collections, category) {
        if (!collections) return;
        return collections.filter((collection) => {
          return collection.category == category;
        });
      }
    }

    window.customElements.define(MyTickets.is, MyTickets);
  </script>
</dom-module>