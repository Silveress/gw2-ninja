<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="shared-styles.html">

<link rel="import" href="./directory/directory-entry.html">

<dom-module id="my-directory">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        min-height: calc(100vh - 4rem);
      }

      paper-tabs {
        background-color: var(--app-primary-color);
        --paper-tabs-selection-bar-color: #ffffff;
      }

      paper-tab {
        color: white;
      }

      .search {
        margin: 1.25rem;
        position: relative;
      }

      .search-field {
        padding: .9375rem 3rem .9375rem var(--spacer-medium);
        font-size: 1rem;
        display: block;
        box-sizing: border-box;
        width: 100%;
        border: 0;
        border-radius: var(--app-border-radius);
        box-shadow: 0 1px 4px rgba(0,0,0,.12);
      }

      .search-clear {
        position: absolute;
        right: .25rem;
        top: .25rem;
        color: #BDBDBD;
      }

      .directory-list {
        display: flex;
        justify-content: space-between;
        align-items: stretch;
        flex-wrap: wrap;
        margin: 1.25rem;
      }

      directory-entry {
        flex-basis: 100%;
        margin-bottom: 1.25rem;
      }

      @media screen and (min-width: 768px) {
        directory-entry {
          flex-basis: calc(100% / 2 - .625rem);
        }
      }
    </style>

    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}" pattern="/directory/:subview" data="{{subviewData}}"></app-route>

    <paper-tabs selected="{{subviewData.subview}}" attr-for-selected="name" fallback-selection="websites">
      <paper-tab name="websites">Websites</paper-tab>
      <paper-tab name="streamers">Streamers</paper-tab>
      <paper-tab name="youtube">YouTube</paper-tab>
    </paper-tabs>

    <div class="search">
      <input class="search-field" type="text" value="{{searchValue::input}}" placeholder$="Search for [[searchForText]]">
      <paper-icon-button class="search-clear" icon="icons:cancel" hidden$="[[ _hideClearSearch(searchValue) ]]" on-tap="_clearSearchValue"></paper-icon-button>
    </div>

    <iron-pages selected="{{subviewData.subview}}" attr-for-selected="name" fallback-selection="websites">
      <div name="websites" class="directory-list">
        <template is="dom-repeat" items="{{websites}}">
          <directory-entry name="[[item.name]]" url="[[item.url]]" description="[[item.description]]"></directory-entry>
        </template>
      </div>
      <div name="streamers" class="directory-list">
        <template is="dom-repeat" items="{{twitch}}">
          <directory-entry name="[[item.name]]" url="[[item.url]]" description="[[item.description]]"></directory-entry>
        </template>
      </div>
      <div name="youtube" class="directory-list">
        <template is="dom-repeat" items="{{youtube}}">
          <directory-entry name="[[item.name]]" url="[[item.url]]" description="[[item.description]]"></directory-entry>
        </template>
      </div>
    </iron-pages>

    <paper-toast id="toast" duration="0" text="An error occured."></paper-toast>
    
  </template>

  <script>
    class MyDirectory extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() { return 'my-directory'; }

      static get properties() {
        return {
          subviewData: {
            observer: "_selectedObserver"
          },
          searchValue: {
            type: String
          },
          searchForText: {
            type: String,
            computed: '_computeSearchForText(subviewData.subview)'
          },
          entries: {
            type: Array
          },
          entriesFiltered: {
            type: Array,
            computed: '_entriesFilteredObserver(entries, searchValue)',
          },
          websites: {
            type: Array
          },
          twitch: {
            type: Array
          },
          youtube: {
            type: Array
          }
        };
      }

      ready() {
        super.ready();
        Polymer.RenderStatus.afterNextRender(this, function() {
          this._loadDirectoryData();
        });
      }

      _loadDirectoryData() {
        fetch('/src/data/directory.json')
          .then((resp) => resp.json())
          .then((data) => {
            this.set('entries', data);
          })
          .catch((err) => {
            console.log(err);
            this.$.toast.fitInto = this;
            this.$.toast.open();
          });
      }

      _selectedObserver(selected) {
        this.set('searchValue', '');
      }

      _entriesFilteredObserver(entries, searchValue) {
        let entriesFiltered = entries;

        if (searchValue !== '') {
          entriesFiltered = entries.filter((entry) => {
            return entry.name.toLowerCase().includes(searchValue.toLowerCase()) || entry.description.toLowerCase().includes(searchValue.toLowerCase());
          });
        }

        this.set('websites', this._filterEntries(entriesFiltered, 'websites'));
        this.set('twitch', this._filterEntries(entriesFiltered, 'twitch'));
        this.set('youtube', this._filterEntries(entriesFiltered, 'youtube'));
      }

      _filterEntries(entries, directory) {
        if (!entries) return;
        return entries.filter((entry) => {
          return entry.directory == directory;
        });
      }

      _computeSearchForText(selected) {
        switch (selected) {
          case 'youtube':
            return 'YouTube Channels';
            break;
          case 'streamers':
            return 'Streamers';
            break;
          case 'websites':
          default:
            return 'Websites';
            break;
        }
      }

      _hideClearSearch(value) {
        return value ? false : true;
      }

      _clearSearchValue() {
        this.set('searchValue', '');
      }
    }

    window.customElements.define(MyDirectory.is, MyDirectory);
  </script>
</dom-module>
