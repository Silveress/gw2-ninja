<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/utils/render-status.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/gw2-coin-output/gw2-coin-output.html">
<link rel="import" href="../shared-styles.html">

<dom-module id="page-tickets">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        min-height: calc(100vh - 4rem);
      }

      .title {
        margin: 0;
        font-weight: 300;
        height: 1.75rem;
        display: flex;
        align-items: center;
      }

      .card {
        margin: var(--spacer-large);
        max-width: 30rem;
      }

      gw2-coin-output {
        display: block;
      }

      paper-spinner {
        display: none;
        margin-left: var(--spacer-medium);
      }

      paper-spinner[active] {
        display: inline-block;
      }
    </style>

    <p class="description">Ever wondered what it would cost to buy a Black Lion Claim Ticket with gold?<br> This tool does the math for you, so you don't have to.</p>

    <div class="card">
      <p class="title">Average Listing Price
          <paper-spinner active="[[averageSellLoading]]"></paper-spinner></p>
      <gw2-coin-output class="display-3" coin-string="[[averageSell]]"></gw2-coin-output>
    </div>
    <div class="card">
      <p class="title">Average Order Price
          <paper-spinner active="[[averageBuyLoading]]"></paper-spinner></p>
      <gw2-coin-output class="display-3" coin-string="[[averageBuy]]"></gw2-coin-output>
    </div>

    <paper-toast id="toast" duration="0" text="An error occured."></paper-toast>
  </template>

  <script>
    class PageTickets extends Polymer.Element {
      static get is() { return 'page-tickets'; }

      static get properties() {
        return {
          collectionData: {
            type: Array,
            observer: '_calculateAverage'
          },
          averageBuy: {
            type: Number
          },
          averageSell: {
            type: Number
          },
          averageBuyLoading: {
            type: Boolean,
            value: true
          },
          averageSellLoading: {
            type: Boolean,
            value: true
          }
        };
      }

      ready() {
        super.ready();

        Polymer.RenderStatus.afterNextRender(this, function() {
          this._loadCollectionData();
        });
      }

      _calculateAverage(collectionData) {
        let totalWeapons = 0;
        let totalTickets = 0;
        let totalBuy = 0;
        let totalSell = 0;

        collectionData.forEach(collection => {
          let tempTotals = this._calcTotalPrices(collection.items);
          totalBuy += tempTotals.buys;
          totalSell += tempTotals.sells;
          totalWeapons += collection.items.length;
          totalTickets += collection.tickets * collection.items.length;
        });

        let averageBuy = (totalBuy / totalWeapons) / (totalTickets / totalWeapons);
        this.set('averageBuy', averageBuy);
        this.set('averageBuyLoading', false);
        
        let averageSell = (totalSell / totalWeapons) / (totalTickets / totalWeapons);
        this.set('averageSell', averageSell);
        this.set('averageSellLoading', false);
      }

      _calcTotalPrices(items) {
        let totals = {
          buys: 0,
          sells: 0
        };

        items.forEach((item) => { 
          totals.sells += item.sells.unit_price;
          totals.buys += item.buys.unit_price;
        });
    
        return totals;
      }

      async _loadCollectionData() {
        const collectionMeta = await fetch('./src/data/collections.json');

        if (collectionMeta.status !== 200) {
          console.log(collectionMeta.status, collectionMeta.statusText);
          this.$.toast.fitInto = this;
          this.$.toast.open();
        }

        const collectionJson = await collectionMeta.json();
        const collectionData = this._filterEntries(collectionJson, 'blacklion');
        const collectionDataWithPrices = await Promise.all(collectionData.map(async collection => {
          return Object.assign({}, collection, { items: await this._loadItemData(collection.ids) });
        }, this));

        this.set('collectionData', collectionDataWithPrices);
      }

      async _loadItemData(ids) {
        /* TODO: Don't load all item-data. Just get the prices. */
        const itemsData = await fetch('https://api.guildwars2.com/v2/items?ids=' + ids);
        const pricesData = await fetch('https://api.guildwars2.com/v2/commerce/prices?ids=' + ids);
        const itemsJson = await itemsData.json();
        const pricesJson = await pricesData.json();

        return itemsJson.map(item => {
          return Object.assign({}, item, pricesJson.find(price => price.id === item.id));
        });
      }

      _filterEntries(collections, category) {
        if (!collections) return;
        return collections.filter((collection) => {
          return collection.category == category;
        });
      }
    }

    window.customElements.define(PageTickets.is, PageTickets);
  </script>
</dom-module>